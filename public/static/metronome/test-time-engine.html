<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Time Engine Validation Test</title>
    <style>
        body {
            font-family: 'Courier New', monospace;
            background: #1a1a1a;
            color: #fff;
            padding: 20px;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        h1 {
            color: #4CAF50;
        }
        .test-section {
            background: #2a2a2a;
            border: 1px solid #3a3a3a;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }
        button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            margin: 5px;
        }
        button:hover {
            background: #45a049;
        }
        button:disabled {
            background: #666;
            cursor: not-allowed;
        }
        .console {
            background: #000;
            color: #0f0;
            padding: 15px;
            border-radius: 4px;
            font-size: 12px;
            max-height: 400px;
            overflow-y: auto;
            margin-top: 10px;
        }
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        .stat-card {
            background: #333;
            padding: 15px;
            border-radius: 4px;
        }
        .stat-label {
            color: #888;
            font-size: 12px;
            margin-bottom: 5px;
        }
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #4CAF50;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>‚è±Ô∏è PHASE 5A ‚Äì Master Time Engine Validation</h1>
        
        <div class="test-section">
            <h2>üéØ Test 1: Initialize Time Engine</h2>
            <button id="btn-init">Initialize AudioContext & Time Engine</button>
            <div class="stats" id="init-stats"></div>
        </div>
        
        <div class="test-section">
            <h2>üéµ Test 2: Scientific Validation (Phase 5A.1)</h2>
            <button id="btn-test-metronome" disabled>Run Metronome Test</button>
            <div class="stats" id="metronome-stats"></div>
        </div>
        
        <div class="test-section">
            <h2>üî¥ Test 2.5: Real Runtime Validation (Phase 5A.2)</h2>
            <p style="color: #ff6b6b; font-size: 12px;">‚ö†Ô∏è This test plays 100 audio clicks. Please ensure volume is at comfortable level.</p>
            <button id="btn-test-runtime" disabled>Run Real Audio Timing Test</button>
            <div class="stats" id="runtime-stats"></div>
        </div>
        
        <div class="test-section">
            <h2>üî¥ Test 2.6: Audio Thread Validation (Phase 5A.3) - REQUIRED</h2>
            <p style="color: #ff6b6b; font-size: 12px;">‚ö†Ô∏è This test plays 100 audio clicks and measures timing in audio rendering thread.</p>
            <p style="color: #ffa500; font-size: 12px;">‚è≥ Test duration: ~51 seconds. Results appear AFTER playback completes.</p>
            <button id="btn-test-audiothread" disabled>Run Audio Thread Validation</button>
            <div class="stats" id="audiothread-stats"></div>
        </div>
        
        <div class="test-section">
            <h2>üé§ Test 3: Input Buffer (Circular Buffer)</h2>
            <button id="btn-test-input" disabled>Run Input Buffer Test</button>
            <div class="stats" id="input-stats"></div>
        </div>
        
        <div class="test-section">
            <h2>üìä Test 4: Latency Measurement</h2>
            <button id="btn-test-latency" disabled>Measure Latency</button>
            <div class="stats" id="latency-stats"></div>
        </div>
        
        <div class="test-section">
            <h2>üìù Console Output</h2>
            <button id="btn-clear-console">Clear Console</button>
            <div class="console" id="console-output"></div>
        </div>
    </div>
    
    <script src="/static/metronome/timeEngine.js"></script>
    <script>
        let audioContext = null;
        let timeEngine = null;
        
        // Console output capture
        const consoleOutput = document.getElementById('console-output');
        const originalConsoleLog = console.log;
        const originalConsoleWarn = console.warn;
        const originalConsoleError = console.error;
        
        function appendToConsole(message, type = 'log') {
            const timestamp = new Date().toLocaleTimeString('en-US', { hour12: false, fractionalSecondDigits: 3 });
            const color = type === 'warn' ? '#ff0' : type === 'error' ? '#f00' : '#0f0';
            consoleOutput.innerHTML += `<div style="color: ${color}">[${timestamp}] ${message}</div>`;
            consoleOutput.scrollTop = consoleOutput.scrollHeight;
        }
        
        console.log = function(...args) {
            originalConsoleLog.apply(console, args);
            appendToConsole(args.join(' '), 'log');
        };
        
        console.warn = function(...args) {
            originalConsoleWarn.apply(console, args);
            appendToConsole(args.join(' '), 'warn');
        };
        
        console.error = function(...args) {
            originalConsoleError.apply(console, args);
            appendToConsole(args.join(' '), 'error');
        };
        
        // Test 1: Initialize
        document.getElementById('btn-init').addEventListener('click', async () => {
            try {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                await audioContext.resume();
                
                timeEngine = new MasterTimeEngine(audioContext);
                timeEngine.setDebugMode(true);
                
                document.getElementById('init-stats').innerHTML = `
                    <div class="stat-card">
                        <div class="stat-label">Sample Rate</div>
                        <div class="stat-value">${audioContext.sampleRate} Hz</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Current Time</div>
                        <div class="stat-value">${audioContext.currentTime.toFixed(6)}s</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">State</div>
                        <div class="stat-value">${audioContext.state}</div>
                    </div>
                `;
                
                // Enable other tests
                document.getElementById('btn-test-metronome').disabled = false;
                document.getElementById('btn-test-runtime').disabled = false;
                document.getElementById('btn-test-audiothread').disabled = false;
                document.getElementById('btn-test-input').disabled = false;
                document.getElementById('btn-test-latency').disabled = false;
                document.getElementById('btn-init').disabled = true;
                
                console.log('‚úÖ AudioContext and Time Engine initialized successfully');
            } catch (error) {
                console.error('‚ùå Initialization failed:', error);
            }
        });
        
        // Test 2: Metronome Timeline (Scientific Validation)
        document.getElementById('btn-test-metronome').addEventListener('click', async () => {
            if (!timeEngine) {
                console.error('‚ùå Time Engine not initialized');
                return;
            }
            
            console.log('\nüéµ Starting Metronome Timeline Test (100 ticks @ 120 BPM)...\n');
            
            const bpm = 120;
            const tickCount = 100;
            
            const results = await timeEngine.runValidationTest(bpm, tickCount);
            
            if (results) {
                const statusColor = results.allPassed ? '#4CAF50' : '#f44336';
                const statusText = results.allPassed ? '‚úÖ PASS' : '‚ùå FAIL';
                
                document.getElementById('metronome-stats').innerHTML = `
                    <div class="stat-card">
                        <div class="stat-label">Total Ticks</div>
                        <div class="stat-value">${results.totalTicks}</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Mean Error</div>
                        <div class="stat-value" style="color: ${results.passedMeanError ? '#4CAF50' : '#f44336'}">
                            ${results.meanError.toFixed(6)} ms ${results.passedMeanError ? '‚úÖ' : '‚ùå'}
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Std Dev</div>
                        <div class="stat-value" style="color: ${results.passedStdDev ? '#4CAF50' : '#f44336'}">
                            ${results.stdDeviation.toFixed(6)} ms ${results.passedStdDev ? '‚úÖ' : '‚ùå'}
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Worst Absolute Error</div>
                        <div class="stat-value" style="color: ${results.passedWorstCase ? '#4CAF50' : '#f44336'}">
                            ${results.worstAbsoluteError.toFixed(6)} ms ${results.passedWorstCase ? '‚úÖ' : '‚ùå'}
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Cumulative Drift</div>
                        <div class="stat-value" style="color: ${results.passedCumulativeDrift ? '#4CAF50' : '#f44336'}">
                            ${results.cumulativeDrift.toFixed(6)} ms ${results.passedCumulativeDrift ? '‚úÖ' : '‚ùå'}
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">PHASE 5A.1 STATUS</div>
                        <div class="stat-value" style="color: ${statusColor}; font-size: 20px; font-weight: bold;">
                            ${statusText}
                        </div>
                    </div>
                `;
            }
        });
        
        // Test 2.5: Real Runtime Validation
        document.getElementById('btn-test-runtime').addEventListener('click', async () => {
            if (!timeEngine) {
                console.error('‚ùå Time Engine not initialized');
                return;
            }
            
            console.log('\nüî¥ Starting Real Runtime Validation (100 audio clicks @ 120 BPM)...\n');
            console.log('‚ö†Ô∏è Audio playback in progress. Please wait...\n');
            
            // Disable button during test
            const btn = document.getElementById('btn-test-runtime');
            btn.disabled = true;
            btn.textContent = 'Testing... (playing 100 clicks)';
            
            const bpm = 120;
            const clickCount = 100;
            
            const results = await timeEngine.realRuntimeValidation(bpm, clickCount);
            
            // Re-enable button
            btn.disabled = false;
            btn.textContent = 'Run Real Audio Timing Test';
            
            if (results) {
                const statusColor = results.allPassed ? '#4CAF50' : '#f44336';
                const statusText = results.allPassed ? '‚úÖ PASS' : '‚ùå FAIL';
                
                document.getElementById('runtime-stats').innerHTML = `
                    <div class="stat-card">
                        <div class="stat-label">Total Clicks</div>
                        <div class="stat-value">${results.totalClicks}</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Mean Execution Error</div>
                        <div class="stat-value" style="color: ${results.passedMeanError ? '#4CAF50' : '#f44336'}">
                            ${results.meanExecutionError.toFixed(6)} ms ${results.passedMeanError ? '‚úÖ' : '‚ùå'}
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Std Dev</div>
                        <div class="stat-value" style="color: ${results.passedStdDev ? '#4CAF50' : '#f44336'}">
                            ${results.stdExecutionError.toFixed(6)} ms ${results.passedStdDev ? '‚úÖ' : '‚ùå'}
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Worst Absolute Error</div>
                        <div class="stat-value" style="color: ${results.passedWorstCase ? '#4CAF50' : '#f44336'}">
                            ${results.worstAbsoluteExecutionError.toFixed(6)} ms ${results.passedWorstCase ? '‚úÖ' : '‚ùå'}
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Scheduling Overhead</div>
                        <div class="stat-value">
                            ${results.meanSchedulingOverhead.toFixed(6)} ms
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">PHASE 5A.2 STATUS</div>
                        <div class="stat-value" style="color: ${statusColor}; font-size: 20px; font-weight: bold;">
                            ${statusText}
                        </div>
                    </div>
                `;
            }
        });
        
        // Test 2.6: Audio Thread Validation
        document.getElementById('btn-test-audiothread').addEventListener('click', async () => {
            if (!timeEngine) {
                console.error('‚ùå Time Engine not initialized');
                return;
            }
            
            console.log('\nüî¥ Starting Audio Thread Validation (100 audio clicks @ 120 BPM)...\n');
            console.log('‚ö†Ô∏è Audio playback in progress. Results will appear AFTER completion (~51 seconds)...\n');
            
            // Disable button during test
            const btn = document.getElementById('btn-test-audiothread');
            btn.disabled = true;
            btn.textContent = 'Testing... (measuring audio frames)';
            
            const bpm = 120;
            const clickCount = 100;
            
            const results = await timeEngine.audioThreadValidation(bpm, clickCount);
            
            // Re-enable button
            btn.disabled = false;
            btn.textContent = 'Run Audio Thread Validation';
            
            if (results) {
                const statusColor = results.allPassed ? '#4CAF50' : '#f44336';
                const statusText = results.allPassed ? '‚úÖ PASS' : '‚ùå FAIL';
                
                document.getElementById('audiothread-stats').innerHTML = `
                    <div class="stat-card">
                        <div class="stat-label">Total Measurements</div>
                        <div class="stat-value">${results.totalMeasurements}</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Mean Execution Error</div>
                        <div class="stat-value" style="color: ${results.passedMeanError ? '#4CAF50' : '#f44336'}">
                            ${results.meanExecutionError.toFixed(6)} ms ${results.passedMeanError ? '‚úÖ' : '‚ùå'}
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Std Dev</div>
                        <div class="stat-value" style="color: ${results.passedStdDev ? '#4CAF50' : '#f44336'}">
                            ${results.stdExecutionError.toFixed(6)} ms ${results.passedStdDev ? '‚úÖ' : '‚ùå'}
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Worst Absolute Error</div>
                        <div class="stat-value" style="color: ${results.passedWorstCase ? '#4CAF50' : '#f44336'}">
                            ${results.worstAbsoluteError.toFixed(6)} ms ${results.passedWorstCase ? '‚úÖ' : '‚ùå'}
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Sample Rate</div>
                        <div class="stat-value">
                            ${results.sampleRate} Hz
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">PHASE 5A.3 STATUS</div>
                        <div class="stat-value" style="color: ${statusColor}; font-size: 20px; font-weight: bold;">
                            ${statusText}
                        </div>
                    </div>
                `;
            }
        });
        
        // Test 3: Input Buffer
        document.getElementById('btn-test-input').addEventListener('click', () => {
            if (!timeEngine) {
                console.error('‚ùå Time Engine not initialized');
                return;
            }
            
            console.log('\nüé§ Starting Input Buffer Test (10000 samples)...\n');
            
            timeEngine.clearInputBuffer();
            
            const sampleCount = 10000;
            const startTime = performance.now();
            
            for (let i = 0; i < sampleCount; i++) {
                const amplitude = Math.random() * 0.5;
                const spectralEnergy = Math.random() * 100;
                timeEngine.recordInputSample(i, amplitude, spectralEnergy);
            }
            
            const endTime = performance.now();
            const duration = endTime - startTime;
            const samples = timeEngine.getInputSamples();
            
            document.getElementById('input-stats').innerHTML = `
                <div class="stat-card">
                    <div class="stat-label">Samples Recorded</div>
                    <div class="stat-value">${samples.length}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Recording Duration</div>
                    <div class="stat-value">${duration.toFixed(2)}ms</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Samples/sec</div>
                    <div class="stat-value">${((sampleCount / duration) * 1000).toFixed(0)}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Buffer Size</div>
                    <div class="stat-value">${timeEngine.maxInputBufferSize}</div>
                </div>
            `;
            
            console.log(`‚úÖ Input buffer test complete: ${samples.length} samples in ${duration.toFixed(2)}ms`);
        });
        
        // Test 4: Latency
        document.getElementById('btn-test-latency').addEventListener('click', () => {
            if (!timeEngine) {
                console.error('‚ùå Time Engine not initialized');
                return;
            }
            
            console.log('\nüìä Measuring Audio Latency...\n');
            
            timeEngine.refreshLatency();
            const latency = timeEngine.getLatencyInfo();
            
            const baseLatencyMs = latency.baseLatency ? (latency.baseLatency * 1000).toFixed(3) : 'N/A';
            const outputLatencyMs = latency.outputLatency ? (latency.outputLatency * 1000).toFixed(3) : 'N/A';
            const totalLatencyMs = (latency.baseLatency && latency.outputLatency) 
                ? ((latency.baseLatency + latency.outputLatency) * 1000).toFixed(3)
                : 'N/A';
            
            document.getElementById('latency-stats').innerHTML = `
                <div class="stat-card">
                    <div class="stat-label">Base Latency</div>
                    <div class="stat-value">${baseLatencyMs}ms</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Output Latency</div>
                    <div class="stat-value">${outputLatencyMs}ms</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Total Latency</div>
                    <div class="stat-value">${totalLatencyMs}ms</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Last Measured</div>
                    <div class="stat-value">${latency.lastMeasured.toFixed(3)}s</div>
                </div>
            `;
            
            console.log('‚úÖ Latency measurement complete');
        });
        
        // Clear console
        document.getElementById('btn-clear-console').addEventListener('click', () => {
            consoleOutput.innerHTML = '';
        });
        
        console.log('üéØ PHASE 5A Validation Test Suite Ready');
        console.log('Click "Initialize AudioContext & Time Engine" to begin');
    </script>
</body>
</html>
