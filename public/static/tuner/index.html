<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
  <title>SHRED UP - Tuner V3</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&display=swap" rel="stylesheet">
  <style>
    @font-face {
      font-family: 'Conthrax';
      src: url('/static/metronome/fonts/conthrax-sb.woff2') format('woff2'),
           url('/static/metronome/fonts/conthrax-sb.woff') format('woff');
      font-weight: 600;
      font-style: normal;
      font-display: swap;
    }
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Helvetica Neue', Arial, sans-serif;
      width: 100%;
      height: 592px;
      min-height: 592px;
      margin: 0;
      padding: 0;
      overflow: hidden;
      
      /* Background identique au mÃ©tronome */
      background: linear-gradient(180deg, 
        #141414 0%, 
        #161616 15%, 
        #181818 30%, 
        #1a1a1a 45%, 
        #1b1b1b 50%, 
        #1a1a1a 55%, 
        #181818 70%, 
        #161616 85%, 
        #151515 100%);
      background-size: 100% 100%;
      background-attachment: fixed;
      color: #666;
    }

    .container {
      max-width: 100%;
      width: 100%;
      height: 592px;
      padding: 10px;
      display: flex;
      flex-direction: column;
      /* Pas de background ici, le body gÃ¨re */
    }

    .header {
      text-align: center;
      margin-bottom: 20px;
      display: none;
    }

    .sample {
      background: transparent;
      border-radius: 12px;
      padding: 12px;
      position: relative;
      border: none;
      flex: 1;
      display: flex;
      flex-direction: column;
      min-height: 0;
    }

    .sample-label {
      position: absolute;
      top: -12px;
      left: 40px;
      background: #1a1a1a;
      color: #666;
      padding: 4px 16px;
      font-size: 10px;
      font-weight: 400;
      letter-spacing: 2px;
      text-transform: uppercase;
      border: 1px solid #333;
      display: none;
    }

    /* Toggle Buttons Container - TWO TOGGLES */
    .toggles-container {
      position: absolute;
      bottom: 42px;
      right: 12px;
      z-index: 100;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    
    .toggle-container {
      /* No absolute positioning here, managed by parent */
    }
    
    .toggle-btn {
      width: 60px;
      height: 28px;
      background: #1a1a1a;
      border-radius: 14px;
      border: 1px solid #222;
      position: relative;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 
        inset 2px 2px 5px rgba(0,0,0,0.5),
        inset -2px -2px 5px rgba(255,255,255,0.02);
    }
    
    .toggle-btn.active {
      background: #1e1e1e;
      box-shadow: 
        inset 2px 2px 5px rgba(0,0,0,0.3),
        inset -2px -2px 5px rgba(255,255,255,0.03);
    }
    
    .toggle-knob {
      width: 22px;
      height: 22px;
      background: linear-gradient(135deg, #2a2a2a, #1a1a1a);
      border-radius: 50%;
      position: absolute;
      top: 2px;
      left: 3px;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: 
        2px 2px 4px rgba(0,0,0,0.4),
        -1px -1px 2px rgba(255,255,255,0.03);
    }
    
    .toggle-btn.active .toggle-knob {
      left: 35px;
      background: linear-gradient(135deg, #3a3a3a, #2a2a2a);
    }
    
    .toggle-label {
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      font-size: 8px;
      font-weight: 500;
      letter-spacing: 1px;
      transition: all 0.3s ease;
      text-transform: uppercase;
    }
    
    .toggle-label.off {
      right: 6px;
      color: #555;
    }
    
    .toggle-label.on {
      left: 6px;
      color: #fff;
      opacity: 0;
      transition: all 0.3s ease;
    }
    
    .toggle-btn.active .toggle-label.off {
      opacity: 0;
    }
    
    .toggle-btn.active .toggle-label.on {
      opacity: 1;
      color: #ff5050;
      text-shadow: none;
    }

    .bars-row {
      display: flex;
      justify-content: center;
      gap: 8px;
      margin-bottom: 12px;
      flex-shrink: 0;
    }
    .bar-item {
      text-align: center;
    }
    .bar {
      width: 16px;
      background: linear-gradient(180deg, #3a3a3a, #2a2a2a);
      margin: 0 auto 4px;
      transition: height 0.3s ease;
    }
    .bar-label {
      font-size: 7px;
      color: #555;
    }

    .hex-area {
      position: relative;
      height: 160px;
      background: rgba(26, 26, 26, 0.3);
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      margin-bottom: 12px;
      flex-shrink: 0;
    }
    .hex {
      width: 40px;
      height: 46px;
      position: relative;
      transition: all 0.3s ease;
    }
    .hex-shape {
      width: 100%;
      height: 100%;
      background: rgba(26, 26, 26, 0.5);
      border: 1px solid rgba(42, 42, 42, 0.8);
      clip-path: polygon(50% 0%, 100% 25%, 100% 75%, 50% 100%, 0% 75%, 0% 25%);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 9px;
      color: #555;
      transition: all 0.3s ease;
    }
    .hex.active .hex-shape {
      background: rgba(30, 30, 30, 0.8);
      border-color: rgba(58, 58, 58, 0.9);
      color: #888;
    }

    .v2-top {
      position: absolute;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      text-align: center;
      pointer-events: none;
    }
    .v2-note {
      font-size: 52px;
      font-weight: 600;
      font-family: 'Conthrax', 'Orbitron', sans-serif;
      letter-spacing: 3px;
      transition: color 0.2s ease, text-shadow 0.2s ease;
      line-height: 1;
      /* Color and text-shadow dynamically set by JavaScript based on cents */
      /* Default: rgba(80, 80, 80, 0.5) like BPM display */
      color: rgba(80, 80, 80, 0.5);
    }
    .v2-bottom {
      position: absolute;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      text-align: center;
      pointer-events: none;
    }
    .v2-freq {
      font-size: 11px;
      color: #555;
      letter-spacing: 2px;
      transition: all 0.3s ease;
    }

    /* Cents line visualization */
    .cents-line {
      height: 50px;
      background: rgba(26, 26, 26, 0.3);
      border-radius: 6px;
      position: relative;
      margin-bottom: 10px;
      border: 1px solid rgba(34, 34, 34, 0.5);
      overflow: hidden;
      flex-shrink: 0;
    }
    .cents-line-graph {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      height: 100%;
      pointer-events: none;
    }
    .cents-line-track {
      position: absolute;
      top: 50%;
      left: 0;
      right: 0;
      height: 1px;
      background: #2a2a2a;
    }
    .cents-info {
      position: absolute;
      top: 4px;
      left: 8px;
      font-size: 8px;
      color: #555;
      letter-spacing: 1px;
      text-transform: uppercase;
    }
    .cents-value {
      color: #888;
      font-weight: 400;
    }

    /* Tuning meter */
    .tuning-meter {
      height: 40px;
      background: rgba(26, 26, 26, 0.3);
      border-radius: 6px;
      position: relative;
      margin-bottom: 10px;
      border: 1px solid rgba(34, 34, 34, 0.5);
      overflow: hidden;
      flex-shrink: 0;
    }
    .meter-track {
      position: absolute;
      top: 50%;
      left: 0;
      right: 0;
      height: 1px;
      background: #2a2a2a;
    }
    .meter-center-mark {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 2px;
      height: 24px;
      background: #3a3a3a;
    }
    .meter-marks {
      position: absolute;
      top: 50%;
      left: 0;
      right: 0;
      transform: translateY(-50%);
      display: flex;
      justify-content: space-between;
      padding: 0 40px;
    }
    .meter-mark {
      width: 1px;
      height: 12px;
      background: #2a2a2a;
    }
    .meter-needle {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 2px;
      height: 26px;
      /* Color dynamically set by JavaScript based on cents */
      background: linear-gradient(180deg, transparent 0%, #888 30%, #888 70%, transparent 100%);
      transition: left 0.2s cubic-bezier(0.34, 1.56, 0.64, 1), background 0.2s ease, filter 0.2s ease;
      z-index: 10;
    }
    .meter-needle::before {
      content: '';
      position: absolute;
      top: -4px;
      left: 50%;
      transform: translateX(-50%);
      width: 0;
      height: 0;
      border-left: 3px solid transparent;
      border-right: 3px solid transparent;
      border-top: 5px solid #888;
      transition: border-top-color 0.2s ease;
    }
    .meter-labels {
      position: absolute;
      bottom: 4px;
      left: 0;
      right: 0;
      display: flex;
      justify-content: space-between;
      padding: 0 25px;
      font-size: 7px;
      color: #555;
      letter-spacing: 0.5px;
    }

    .controls {
      display: none;
    }

  </style>
</head>
<body>
  <div class="container">
    <div class="sample">
      <!-- THREE Toggle Buttons - TUNING, BEND and ON/OFF -->
      <div class="toggles-container">
        <!-- TUNING Toggle (top) -->
        <div class="toggle-container">
          <div class="toggle-btn active" id="tuning-toggle">
            <div class="toggle-knob"></div>
            <span class="toggle-label on">STD</span>
            <span class="toggle-label off">Dâ†“</span>
          </div>
        </div>
        
        <!-- BEND Toggle (middle) -->
        <div class="toggle-container">
          <div class="toggle-btn" id="bend-toggle">
            <div class="toggle-knob"></div>
            <span class="toggle-label on">BEND</span>
            <span class="toggle-label off">BEND</span>
          </div>
        </div>
        
        <!-- ON/OFF Toggle (bottom) -->
        <div class="toggle-container">
          <div class="toggle-btn" id="power-toggle">
            <div class="toggle-knob"></div>
            <span class="toggle-label on">ON</span>
            <span class="toggle-label off">OFF</span>
          </div>
        </div>
      </div>

      <div class="bars-row">
        <div class="bar-item">
          <div class="bar" id="bar-0" style="height: 60px;"></div>
          <div class="bar-label">A1</div>
        </div>
        <div class="bar-item">
          <div class="bar" id="bar-1" style="height: 75px;"></div>
          <div class="bar-label">D2</div>
        </div>
        <div class="bar-item">
          <div class="bar" id="bar-2" style="height: 90px;"></div>
          <div class="bar-label">G2</div>
        </div>
        <div class="bar-item">
          <div class="bar" id="bar-3" style="height: 78px;"></div>
          <div class="bar-label">C3</div>
        </div>
        <div class="bar-item">
          <div class="bar" id="bar-4" style="height: 68px;"></div>
          <div class="bar-label">F3</div>
        </div>
        <div class="bar-item">
          <div class="bar" id="bar-5" style="height: 58px;"></div>
          <div class="bar-label">A3</div>
        </div>
        <div class="bar-item">
          <div class="bar" id="bar-6" style="height: 48px;"></div>
          <div class="bar-label">D4</div>
        </div>
      </div>

      <div class="hex-area">
        <div class="hex" id="hex-0">
          <div class="hex-shape">A1</div>
        </div>
        <div class="hex" id="hex-1">
          <div class="hex-shape">D2</div>
        </div>
        <div class="hex active" id="hex-2">
          <div class="hex-shape">G2</div>
        </div>
        <div class="hex" id="hex-3">
          <div class="hex-shape">C3</div>
        </div>
        <div class="hex" id="hex-4">
          <div class="hex-shape">F3</div>
        </div>
        <div class="hex" id="hex-5">
          <div class="hex-shape">A3</div>
        </div>
        <div class="hex" id="hex-6">
          <div class="hex-shape">D4</div>
        </div>

        <div class="v2-top">
          <div class="v2-note" id="note-display">A1</div>
        </div>
        <div class="v2-bottom">
          <div class="v2-freq" id="freq-display">55.00 HZ</div>
        </div>
      </div>

      <!-- Cents line visualization -->
      <div class="cents-line">
        <canvas id="cents-canvas" class="cents-line-graph" width="720" height="50"></canvas>
        <div class="cents-line-track"></div>
        <div class="cents-info">
          STRING <span class="cents-value" id="string-info">1/7</span> Â· 
          <span class="cents-value" id="cents-info">-4</span> CENTS
        </div>
      </div>

      <!-- Tuning meter -->
      <div class="tuning-meter">
        <div class="meter-track"></div>
        <div class="meter-center-mark"></div>
        <div class="meter-marks">
          <div class="meter-mark"></div>
          <div class="meter-mark"></div>
          <div class="meter-mark"></div>
          <div class="meter-mark"></div>
          <div class="meter-mark"></div>
          <div class="meter-mark"></div>
          <div class="meter-mark"></div>
          <div class="meter-mark"></div>
          <div class="meter-mark"></div>
        </div>
        <div class="meter-needle" id="meter-needle"></div>
        <div class="meter-labels">
          <span>-50</span>
          <span>-25</span>
          <span style="color: #888;">0</span>
          <span>+25</span>
          <span>+50</span>
        </div>
      </div>
    </div>
  </div>

  <!-- Load audio engine modules for DSP integration -->
  <script src="/static/audio-engine/debug-logger.js"></script>
  <script src="/static/audio-engine/audio-capture.js"></script>
  <script src="/static/audio-engine/metronome-adapter.js"></script>
  <script src="/static/audio-engine/frame-buffer.js"></script>
  <script src="/static/audio-engine/timing-sync.js"></script>
  <script src="/static/audio-engine/dsp/spectral-analyzer.js"></script>
  <script src="/static/audio-engine/dsp/low-frequency-specialist.js"></script>
  <script src="/static/audio-engine/dsp/octave-consistency-stabilizer.js"></script>
  <script src="/static/audio-engine/dsp/pitch-detection.js"></script>
  <script src="/static/audio-engine/audio-engine-phase3.js"></script>
  <script src="/static/tuner/tuner-dsp-bridge.js"></script>

  <script>
    // 7-string guitar tunings
    const E_STANDARD_TUNING = [
      { name: 'B1', freq: 61.74, string: 1 },
      { name: 'E2', freq: 82.41, string: 2 },
      { name: 'A2', freq: 110.0, string: 3 },
      { name: 'D3', freq: 146.83, string: 4 },
      { name: 'G3', freq: 196.0, string: 5 },
      { name: 'B3', freq: 246.94, string: 6 },
      { name: 'E4', freq: 329.63, string: 7 }
    ];
    
    const D_STANDARD_TUNING = [
      { name: 'A1', freq: 55.0, string: 1 },
      { name: 'D2', freq: 73.42, string: 2 },
      { name: 'G2', freq: 98.0, string: 3 },
      { name: 'C3', freq: 130.81, string: 4 },
      { name: 'F3', freq: 174.61, string: 5 },
      { name: 'A3', freq: 220.0, string: 6 },
      { name: 'D4', freq: 293.66, string: 7 }
    ];
    
    let NOTES = E_STANDARD_TUNING; // Default: E Standard
    let isStandardTuning = true; // Start with E Standard
    
    let currentNoteIndex = 0; // Start with A1
    let tunerRunning = false;
    let dspInitialized = false;
    let animationFrame = null;
    let currentCents = -4;
    let hasActiveDetection = false; // Track if we're receiving real signal
    
    // DOM elements
    const noteEl = document.getElementById('note-display');
    const freqEl = document.getElementById('freq-display');
    const stringInfoEl = document.getElementById('string-info');
    const centsInfoEl = document.getElementById('cents-info');
    const needleEl = document.getElementById('meter-needle');
    const powerToggle = document.getElementById('power-toggle');
    const bendToggle = document.getElementById('bend-toggle');
    const tuningToggle = document.getElementById('tuning-toggle');
    const bars = [];
    const hexes = [];
    
    // Cents line canvas
    const centsCanvas = document.getElementById('cents-canvas');
    const centsCtx = centsCanvas.getContext('2d');
    const centsHistory = [];
    const maxCentsHistory = 120;
    
    let bendMode = false; // BEND toggle state
    
    for (let i = 0; i < 7; i++) {
      bars.push(document.getElementById(`bar-${i}`));
      hexes.push(document.getElementById(`hex-${i}`));
    }
    
    // Initialize barHeights with base heights to prevent initial glitch
    const barHeights = [];
    for (let i = 0; i < 7; i++) {
      barHeights.push(48 + i * 6); // Same as baseHeight calculation
    }
    
    // Calculate note color and glow based on cents
    // White at center (Â±2 cents), gradient to gray at extremes
    // Real cents range: approximately -12 to +12 (not -50 to +50)
    function getNoteColorAndGlow(cents) {
      const absCents = Math.abs(cents);
      
      // Pure white with subtle glow for perfect tuning (Â±2 cents)
      // Original glow: 0 0 20px rgba(255,255,255,0.8), 0 0 40px rgba(255,255,255,0.4)
      // Reduced by 70%: multiply alpha by 0.3
      if (absCents <= 2) {
        return {
          color: 'rgba(255, 255, 255, 1)',
          textShadow: '0 0 20px rgba(255, 255, 255, 0.24), 0 0 40px rgba(255, 255, 255, 0.12)'
        };
      }
      
      // Map cents (2-12) to gradient position (0-100%)
      // Using metronome slider gradient (inverted: white at top)
      const position = Math.min(100, ((absCents - 2) / 10) * 100); // 0-100% over 10 cents range
      
      // Gradient from white to dark gray (metronome slider inverted)
      const gradientStops = [
        { pos: 0,   rgb: [255, 255, 255], alpha: 1.0 },    // White (center)
        { pos: 10,  rgb: [236, 236, 236], alpha: 0.95 },
        { pos: 20,  rgb: [212, 212, 212], alpha: 0.9 },
        { pos: 30,  rgb: [184, 184, 184], alpha: 0.85 },
        { pos: 40,  rgb: [157, 157, 157], alpha: 0.8 },
        { pos: 50,  rgb: [131, 131, 131], alpha: 0.75 },
        { pos: 60,  rgb: [107, 107, 107], alpha: 0.7 },
        { pos: 70,  rgb: [85,  85,  85],  alpha: 0.65 },
        { pos: 80,  rgb: [66,  66,  66],  alpha: 0.6 },
        { pos: 90,  rgb: [50,  50,  50],  alpha: 0.55 },
        { pos: 100, rgb: [80,  80,  80],  alpha: 0.5 }     // BPM display gray (extreme)
      ];
      
      // Find the two stops to interpolate between
      let lowerStop = gradientStops[0];
      let upperStop = gradientStops[gradientStops.length - 1];
      
      for (let i = 0; i < gradientStops.length - 1; i++) {
        if (position >= gradientStops[i].pos && position <= gradientStops[i + 1].pos) {
          lowerStop = gradientStops[i];
          upperStop = gradientStops[i + 1];
          break;
        }
      }
      
      // Interpolate RGB and alpha values
      const range = upperStop.pos - lowerStop.pos;
      const ratio = (position - lowerStop.pos) / range;
      
      const r = Math.round(lowerStop.rgb[0] + (upperStop.rgb[0] - lowerStop.rgb[0]) * ratio);
      const g = Math.round(lowerStop.rgb[1] + (upperStop.rgb[1] - lowerStop.rgb[1]) * ratio);
      const b = Math.round(lowerStop.rgb[2] + (upperStop.rgb[2] - lowerStop.rgb[2]) * ratio);
      const alpha = lowerStop.alpha + (upperStop.alpha - lowerStop.alpha) * ratio;
      
      return {
        color: `rgba(${r}, ${g}, ${b}, ${alpha.toFixed(2)})`,
        textShadow: 'none'
      };
    }
    
    // Get cents from DSP (real pitch detection)
    function getCurrentCents() {
      if (!tunerDSP || !tunerDSP.isRunning) {
        // Mock data when DSP is not running (for testing UI)
        const base = Math.sin(Date.now() / 1000) * 10; // -10 to +10
        const noise = (Math.random() - 0.5) * 4; // Â±2 noise
        return Math.round(base + noise);
      }
      
      // Real DSP data
      const cents = tunerDSP.getCentOffset();
      return cents !== null ? cents : 0;
    }
    
    // Get current note from DSP
    function getCurrentNoteFromDSP() {
      if (!tunerDSP || !tunerDSP.isRunning) {
        // Mock data: cycle through notes when DSP not running
        hasActiveDetection = true; // Mock mode always has signal
        return NOTES[currentNoteIndex];
      }
      
      // Real DSP data
      const detection = tunerDSP.getLastDetection();
      
      if (detection.note) {
        hasActiveDetection = true; // We have a real detection
        
        // Find matching note in NOTES array
        const noteData = NOTES.find(n => n.name === detection.note);
        if (noteData) {
          return {
            name: detection.note,
            freq: detection.frequency,
            string: detection.string
          };
        }
      }
      
      // No current detection
      hasActiveDetection = false;
      
      // Return last valid note but signal UI has no detection
      return NOTES[currentNoteIndex];
    }
    
    // Smoothing factor to prevent bar glitches (lower = smoother)
    const SMOOTH_FACTOR = 0.15;
    
    // Update bars heights + gradient based on tuning accuracy (NO GLITCH)
    function updateBars() {
      bars.forEach((bar, i) => {
        const baseHeight = 48 + i * 6; // Base heights: 48, 54, 60, 66, 72, 78, 84
        
        // Calculate target height
        let targetHeight = baseHeight;
        if (i === currentNoteIndex) {
          // Active bar: height grows as note becomes more accurate
          const accuracy = Math.max(0, 1 - Math.abs(currentCents) / 12); // 1 = perfect, 0 = off by 12+ cents
          const heightBoost = accuracy * 40; // 0-40px boost based on accuracy
          targetHeight = baseHeight + heightBoost;
        }
        
        // Smooth transition to target height (prevents glitches)
        barHeights[i] += (targetHeight - barHeights[i]) * SMOOTH_FACTOR;
        const smoothHeight = Math.max(40, Math.min(100, barHeights[i]));
        bar.style.height = `${smoothHeight}px`;
        
        // Apply gradient only to active bar
        if (i === currentNoteIndex) {
          const { color } = getNoteColorAndGlow(currentCents);
          const rgbMatch = color.match(/rgba?\((\d+),\s*(\d+),\s*(\d+)/);
          if (rgbMatch) {
            const r = rgbMatch[1];
            const g = rgbMatch[2];
            const b = rgbMatch[3];
            // Vertical gradient: tip color (white if accurate) â†’ dark base
            bar.style.background = `linear-gradient(180deg, rgba(${r}, ${g}, ${b}, 0.95) 0%, rgba(58, 58, 58, 1) 100%)`;
          }
        } else {
          // Inactive bars: dark gradient
          bar.style.background = 'linear-gradient(180deg, #3a3a3a 0%, #2a2a2a 100%)';
        }
      });
    }
    
    // Update active hexagon
    function updateHexagons() {
      hexes.forEach((hex, i) => {
        if (i === currentNoteIndex) {
          hex.classList.add('active');
        } else {
          hex.classList.remove('active');
        }
      });
    }
    
    // Draw cents line graph
    function drawCentsLine() {
      const width = centsCanvas.width;
      const height = centsCanvas.height;
      
      // Clear canvas
      centsCtx.clearRect(0, 0, width, height);
      
      // Draw zero line (horizontal center)
      centsCtx.strokeStyle = '#2a2a2a';
      centsCtx.lineWidth = 1;
      centsCtx.beginPath();
      centsCtx.moveTo(0, height / 2);
      centsCtx.lineTo(width, height / 2);
      centsCtx.stroke();
      
      // Draw cents history line
      if (centsHistory.length > 1) {
        centsCtx.strokeStyle = '#666';
        centsCtx.lineWidth = 2;
        centsCtx.beginPath();
        
        const step = width / maxCentsHistory;
        
        centsHistory.forEach((cents, i) => {
          const x = i * step;
          // Map cents (-50 to +50) to y position
          const y = height / 2 - (cents / 50) * (height / 2 - 10);
          
          if (i === 0) {
            centsCtx.moveTo(x, y);
          } else {
            centsCtx.lineTo(x, y);
          }
        });
        
        centsCtx.stroke();
      }
    }
    
    // Update cents history
    function updateCentsHistory() {
      centsHistory.push(currentCents);
      if (centsHistory.length > maxCentsHistory) {
        centsHistory.shift();
      }
      drawCentsLine();
    }
    
    // Update needle position and color
    function updateNeedle() {
      // If no active detection, position needle at minimum (left, waiting state)
      if (!hasActiveDetection) {
        needleEl.style.left = '0%'; // Position Ã  gauche (attente de signal)
        needleEl.style.background = 'linear-gradient(180deg, transparent 0%, #555 30%, #555 70%, transparent 100%)';
        needleEl.style.filter = 'none';
        return;
      }
      
      // Map cents (-50 to +50) to position (0% to 100%)
      const normalizedCents = (currentCents + 50) / 100; // 0 to 1
      const position = normalizedCents * 100;
      needleEl.style.left = `${position}%`;
      
      // Apply same color gradient as note overlay
      const absCents = Math.abs(currentCents);
      
      if (absCents <= 2) {
        // White needle at perfect tuning
        needleEl.style.background = 'linear-gradient(180deg, transparent 0%, rgba(255, 255, 255, 0.9) 30%, rgba(255, 255, 255, 0.9) 70%, transparent 100%)';
        needleEl.style.filter = 'none';
      } else if (absCents <= 12) {
        // Gradient from white to gray (same as note overlay)
        const gradPosition = ((absCents - 2) / 10) * 100;
        const gradientStops = [
          { pos: 0,   rgb: [255, 255, 255] },
          { pos: 10,  rgb: [236, 236, 236] },
          { pos: 20,  rgb: [212, 212, 212] },
          { pos: 30,  rgb: [184, 184, 184] },
          { pos: 40,  rgb: [157, 157, 157] },
          { pos: 50,  rgb: [131, 131, 131] },
          { pos: 60,  rgb: [107, 107, 107] },
          { pos: 70,  rgb: [85,  85,  85]  },
          { pos: 80,  rgb: [66,  66,  66]  },
          { pos: 90,  rgb: [50,  50,  50]  },
          { pos: 100, rgb: [136, 136, 136] }
        ];
        
        let lowerStop = gradientStops[0];
        let upperStop = gradientStops[gradientStops.length - 1];
        
        for (let i = 0; i < gradientStops.length - 1; i++) {
          if (gradPosition >= gradientStops[i].pos && gradPosition <= gradientStops[i + 1].pos) {
            lowerStop = gradientStops[i];
            upperStop = gradientStops[i + 1];
            break;
          }
        }
        
        const range = upperStop.pos - lowerStop.pos;
        const ratio = (gradPosition - lowerStop.pos) / range;
        
        const r = Math.round(lowerStop.rgb[0] + (upperStop.rgb[0] - lowerStop.rgb[0]) * ratio);
        const g = Math.round(lowerStop.rgb[1] + (upperStop.rgb[1] - lowerStop.rgb[1]) * ratio);
        const b = Math.round(lowerStop.rgb[2] + (upperStop.rgb[2] - lowerStop.rgb[2]) * ratio);
        
        const needleColor = `rgb(${r}, ${g}, ${b})`;
        needleEl.style.background = `linear-gradient(180deg, transparent 0%, ${needleColor} 30%, ${needleColor} 70%, transparent 100%)`;
        needleEl.style.filter = 'none';
      } else {
        // Default gray needle
        needleEl.style.background = 'linear-gradient(180deg, transparent 0%, #888 30%, #888 70%, transparent 100%)';
        needleEl.style.filter = 'none';
      }
    }
    
    // Update display
    function updateDisplay() {
      // Get real DSP data
      const note = getCurrentNoteFromDSP();
      currentCents = getCurrentCents();
      
      // Update current note index (for bar animation)
      const noteIndex = NOTES.findIndex(n => n.name === note.name);
      if (noteIndex !== -1) {
        currentNoteIndex = noteIndex;
      }
      
      noteEl.textContent = note.name;
      
      // Apply gradient color and glow
      const style = getNoteColorAndGlow(currentCents);
      noteEl.style.color = style.color;
      noteEl.style.textShadow = style.textShadow;
      
      freqEl.textContent = `${note.freq.toFixed(2)} HZ`;
      
      const centsSign = currentCents >= 0 ? '+' : '';
      stringInfoEl.textContent = `${note.string}/7`;
      centsInfoEl.textContent = `${centsSign}${currentCents}`;
      
      updateHexagons();
      updateNeedle();
      updateCentsHistory();
    }
    
    // Animation loop
    function animate() {
      if (!tunerRunning) return;
      
      updateBars();
      updateDisplay();
      
      animationFrame = requestAnimationFrame(animate);
    }
    
    // Change note every 3 seconds
    function cycleNotes() {
      if (!tunerRunning) return;
      
      currentNoteIndex = (currentNoteIndex + 1) % NOTES.length;
      
      setTimeout(cycleNotes, 3000);
    }
    
    // Toggle power
    powerToggle.addEventListener('click', async () => {
      tunerRunning = !tunerRunning;
      
      if (tunerRunning) {
        powerToggle.classList.add('active');
        
        // Initialize DSP if needed
        if (!dspInitialized) {
          console.log('[TUNER] Initializing DSP...');
          const initSuccess = await tunerDSP.init();
          if (initSuccess) {
            dspInitialized = true;
            console.log('[TUNER] âœ“ DSP initialized');
          } else {
            console.error('[TUNER] âœ— DSP initialization failed');
            // Continue with mock data
          }
        }
        
        // Start DSP
        if (dspInitialized) {
          const startSuccess = await tunerDSP.start();
          if (startSuccess) {
            console.log('[TUNER] âœ“ DSP started (real pitch detection)');
          } else {
            console.error('[TUNER] âœ— DSP start failed (using mock data)');
          }
        }
        
        // Start UI animation
        animate();
        
        // Only cycle notes if DSP is not running (mock mode)
        if (!tunerDSP || !tunerDSP.isRunning) {
          cycleNotes();
        }
      } else {
        powerToggle.classList.remove('active');
        
        // Stop DSP
        if (tunerDSP && tunerDSP.isRunning) {
          await tunerDSP.stop();
          console.log('[TUNER] âœ“ DSP stopped');
        }
        
        // Stop UI animation
        if (animationFrame) {
          cancelAnimationFrame(animationFrame);
          animationFrame = null;
        }
      }
    });
    
    // Toggle BEND mode
    bendToggle.addEventListener('click', () => {
      bendMode = !bendMode;
      
      if (bendMode) {
        bendToggle.classList.add('active');
        console.log('ðŸŽ¸ BEND mode activated');
      } else {
        bendToggle.classList.remove('active');
        console.log('ðŸŽ¸ BEND mode deactivated');
      }
    });
    
    // Toggle TUNING (E Standard / D Standard)
    tuningToggle.addEventListener('click', () => {
      isStandardTuning = !isStandardTuning;
      
      if (isStandardTuning) {
        tuningToggle.classList.add('active');
        NOTES = E_STANDARD_TUNING;
        console.log('ðŸŽ¸ E STANDARD tuning selected (B1, E2, A2, D3, G3, B3, E4)');
      } else {
        tuningToggle.classList.remove('active');
        NOTES = D_STANDARD_TUNING;
        console.log('ðŸŽ¸ D STANDARD tuning selected (A1, D2, G2, C3, F3, A3, D4)');
      }
      
      // Update bars and hexagons labels
      NOTES.forEach((note, i) => {
        const barLabel = document.querySelector(`#bar-${i} + .bar-label`) || document.querySelectorAll('.bar-label')[i];
        const hexShape = document.querySelector(`#hex-${i} .hex-shape`);
        if (barLabel) barLabel.textContent = note.name;
        if (hexShape) hexShape.textContent = note.name;
      });
      
      // Reset current note index
      currentNoteIndex = 0;
      updateHexagons();
    });
    
    // Initialize
    currentCents = -4;
    currentNoteIndex = 0;
    hasActiveDetection = false; // No signal at start
    stringInfoEl.textContent = '1/7';
    centsInfoEl.textContent = '-4';
    
    // Initialize tuning toggle to active (E Standard is default)
    tuningToggle.classList.add('active');
    
    updateHexagons();
    updateNeedle(); // Will position needle at 0% (left) since hasActiveDetection = false
    
    // Resize canvas to fit container
    function resizeCentsCanvas() {
      const rect = centsCanvas.parentElement.getBoundingClientRect();
      centsCanvas.width = rect.width;
      centsCanvas.height = 50;
      drawCentsLine();
    }
    
    resizeCentsCanvas();
    window.addEventListener('resize', resizeCentsCanvas);
    
    console.log('ðŸŽ¸ SHRED UP Tuner V3 loaded - ' + new Date().toISOString());
  </script>
</body>
</html>
